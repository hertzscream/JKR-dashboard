<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Log Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Safe Recharts Access ---
        const { 
            AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, 
            ResponsiveContainer, PieChart, Pie, Cell, Legend 
        } = window.Recharts;

        // --- Icon Component ---
        const LucideIcon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const SAMPLE_DATA = [
            { date: "27/01/2026", stopTime: "16:57:02", startTime: "16:57:20", duration: "0:00:17", cumulative: "0:00:17" },
            { date: "27/01/2026", stopTime: "16:59:00", startTime: "16:59:09", duration: "0:00:08", cumulative: "0:00:26" },
            { date: "28/01/2026", stopTime: "10:16:15", startTime: "10:17:29", duration: "0:01:14", cumulative: "0:01:40" },
            { date: "28/01/2026", stopTime: "10:17:52", startTime: "10:18:03", duration: "0:00:11", cumulative: "0:01:51" },
            { date: "28/01/2026", stopTime: "11:20:00", startTime: "11:20:01", duration: "0:47:11", cumulative: "0:49:03" },
            { date: "28/01/2026", stopTime: "11:21:18", startTime: "11:21:48", duration: "0:00:30", cumulative: "0:49:33" },
            { date: "28/01/2026", stopTime: "11:23:33", startTime: "11:27:07", duration: "0:03:34", cumulative: "0:53:07" },
            { date: "28/01/2026", stopTime: "11:48:07", startTime: "11:50:59", duration: "0:02:52", cumulative: "0:56:00" },
        ];

        const parseDurationToSeconds = (durationStr) => {
            if (!durationStr || typeof durationStr !== 'string' || durationStr === '-') return 0;
            const parts = durationStr.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return 0;
        };

        const formatSeconds = (totalSeconds) => {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            if (h > 0) return `${h} ชม. ${m} นาที`;
            if (m > 0) return `${m} นาที ${s} วิ`;
            return `${s} วิ`;
        };

        function App() {
            const [data, setData] = useState([]);
            const [selectedDate, setSelectedDate] = useState('All');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                // Simulate loading to ensure libraries are ready
                const timer = setTimeout(() => {
                    const processed = SAMPLE_DATA.map((item, index) => ({
                        id: index,
                        ...item,
                        durationSec: parseDurationToSeconds(item.duration),
                    }));
                    setData(processed);
                    setIsLoading(false);
                    if (window.lucide) window.lucide.createIcons();
                }, 500);
                return () => clearTimeout(timer);
            }, []);

            const filteredData = useMemo(() => {
                return selectedDate === 'All' ? data : data.filter(d => d.date === selectedDate);
            }, [data, selectedDate]);

            const stats = useMemo(() => {
                const total = filteredData.length;
                const totalSec = filteredData.reduce((acc, curr) => acc + curr.durationSec, 0);
                const avgSec = total > 0 ? totalSec / total : 0;
                const maxItem = filteredData.reduce((max, curr) => curr.durationSec > max.durationSec ? curr : max, { durationSec: 0 });
                
                const pieData = [
                    { name: 'น้อยกว่า 1 นาที', value: filteredData.filter(d => d.durationSec < 60).length },
                    { name: '1-5 นาที', value: filteredData.filter(d => d.durationSec >= 60 && d.durationSec < 300).length },
                    { name: 'มากกว่า 5 นาที', value: filteredData.filter(d => d.durationSec >= 300).length }
                ].filter(d => d.value > 0);

                return { total, totalSec, avgSec, maxItem, pieData };
            }, [filteredData]);

            const uniqueDates = useMemo(() => ['All', ...new Set(data.map(d => d.date))], [data]);

            if (isLoading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-slate-50">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-500 font-medium">กำลังเตรียมข้อมูล...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex bg-slate-50">
                    {/* Sidebar */}
                    <aside className={`bg-slate-900 text-white transition-all duration-300 flex flex-col fixed h-full z-30 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                        <div className="p-6 border-b border-slate-800 flex items-center justify-between">
                            {isSidebarOpen && <span className="font-bold text-xl tracking-tight">GEN LOG</span>}
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-slate-800 rounded-lg transition-colors mx-auto">
                                <LucideIcon name={isSidebarOpen ? "chevron-left" : "menu"} />
                            </button>
                        </div>
                        
                        <div className="p-4 flex-1 space-y-8 overflow-hidden">
                            <div className="space-y-4">
                                <label className={`text-xs font-bold text-slate-500 uppercase px-2 ${!isSidebarOpen && 'hidden'}`}>ตัวกรองข้อมูล</label>
                                <div className="space-y-2">
                                    <div className={`flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors ${selectedDate === 'All' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}
                                         onClick={() => setSelectedDate('All')}>
                                        <LucideIcon name="layout-grid" className="w-5 h-5" />
                                        {isSidebarOpen && <span className="text-sm">ดูทั้งหมด</span>}
                                    </div>
                                    {uniqueDates.filter(d => d !== 'All').map(date => (
                                        <div key={date} 
                                             className={`flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors ${selectedDate === date ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}
                                             onClick={() => setSelectedDate(date)}>
                                            <LucideIcon name="calendar" className="w-5 h-5" />
                                            {isSidebarOpen && <span className="text-sm">{date}</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-4 border-t border-slate-800">
                            <div className="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-white cursor-pointer">
                                <LucideIcon name="help-circle" />
                                {isSidebarOpen && <span className="text-sm">ความช่วยเหลือ</span>}
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className={`flex-1 transition-all duration-300 ${isSidebarOpen ? 'ml-64' : 'ml-20'} p-4 md:p-8`}>
                        <div className="max-w-7xl mx-auto space-y-8 fade-in">
                            
                            {/* Header */}
                            <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-slate-900">Generator Performance</h1>
                                    <p className="text-slate-500">ข้อมูลสรุป ณ วันที่ {new Date().toLocaleDateString('th-TH')}</p>
                                </div>
                                <div className="flex items-center gap-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200">
                                    <button className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold shadow-indigo-200 shadow-lg hover:bg-indigo-700 transition-all">ส่งออกรายงาน</button>
                                </div>
                            </header>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                                    <div className="relative z-10">
                                        <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">เครื่องดับทั้งหมด</p>
                                        <h3 className="text-3xl font-bold text-slate-900 mt-2">{stats.total} <span className="text-lg font-normal text-slate-400">ครั้ง</span></h3>
                                    </div>
                                    <LucideIcon name="activity" className="absolute -right-4 -bottom-4 w-24 h-24 text-indigo-50/50 group-hover:text-indigo-100 transition-colors" />
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                                    <div className="relative z-10">
                                        <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">ระยะเวลารวม</p>
                                        <h3 className="text-3xl font-bold text-rose-600 mt-2">{formatSeconds(stats.totalSec)}</h3>
                                    </div>
                                    <LucideIcon name="clock" className="absolute -right-4 -bottom-4 w-24 h-24 text-rose-50/50 group-hover:text-rose-100 transition-colors" />
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                                    <div className="relative z-10">
                                        <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">เฉลี่ยต่อครั้ง</p>
                                        <h3 className="text-3xl font-bold text-amber-600 mt-2">{formatSeconds(Math.round(stats.avgSec))}</h3>
                                    </div>
                                    <LucideIcon name="trending-down" className="absolute -right-4 -bottom-4 w-24 h-24 text-amber-50/50 group-hover:text-amber-100 transition-colors" />
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                                    <div className="relative z-10">
                                        <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">ดับนานสูงสุด</p>
                                        <h3 className="text-3xl font-bold text-indigo-600 mt-2">{stats.maxItem.duration || '0:00'}</h3>
                                    </div>
                                    <LucideIcon name="alert-triangle" className="absolute -right-4 -bottom-4 w-24 h-24 text-indigo-50/50 group-hover:text-indigo-100 transition-colors" />
                                </div>
                            </div>

                            {/* Charts Section */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                    <div className="flex items-center justify-between mb-8">
                                        <h3 className="font-bold text-lg text-slate-800">กราฟความถี่และระยะเวลาที่ดับ</h3>
                                        <div className="flex gap-2">
                                            <span className="flex items-center gap-1.5 text-xs text-slate-500">
                                                <span className="w-3 h-3 bg-indigo-500 rounded-full"></span> ระยะเวลา (วินาที)
                                            </span>
                                        </div>
                                    </div>
                                    <div className="h-[350px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={filteredData}>
                                                <defs>
                                                    <linearGradient id="colorDur" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/>
                                                        <stop offset="95%" stopColor="#6366f1" stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="stopTime" fontSize={11} axisLine={false} tickLine={false} tick={{fill: '#94a3b8'}} />
                                                <YAxis axisLine={false} tickLine={false} tick={{fill: '#94a3b8'}} fontSize={11} />
                                                <RechartsTooltip 
                                                    contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}}
                                                    formatter={(value) => [formatSeconds(value), "ระยะเวลา"]}
                                                />
                                                <Area type="monotone" dataKey="durationSec" stroke="#6366f1" strokeWidth={4} fillOpacity={1} fill="url(#colorDur)" />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                    <h3 className="font-bold text-lg text-slate-800 mb-8 text-center">สัดส่วนตามระดับความนาน</h3>
                                    <div className="h-[300px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie data={stats.pieData} innerRadius={60} outerRadius={100} paddingAngle={8} dataKey="value" stroke="none">
                                                    <Cell fill="#6366f1" />
                                                    <Cell fill="#f59e0b" />
                                                    <Cell fill="#f43f5e" />
                                                </Pie>
                                                <RechartsTooltip />
                                                <Legend verticalAlign="bottom" align="center" iconType="circle" wrapperStyle={{paddingTop: '20px', fontSize: '12px'}} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>

                            {/* Table */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                <div className="p-6 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                                    <h3 className="font-bold text-slate-800">ตารางรายละเอียดเหตุการณ์</h3>
                                    <button className="text-indigo-600 text-sm font-bold hover:underline">ดูทั้งหมด</button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead>
                                            <tr className="text-slate-400 text-xs uppercase tracking-widest font-bold">
                                                <th className="px-6 py-4">วันที่</th>
                                                <th className="px-6 py-4">เวลาเครื่องดับ</th>
                                                <th className="px-6 py-4">เวลาเครื่องติด</th>
                                                <th className="px-6 py-4">ระยะเวลา</th>
                                                <th className="px-6 py-4">สถานะ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm divide-y divide-slate-100">
                                            {filteredData.map((row) => (
                                                <tr key={row.id} className="hover:bg-slate-50 transition-colors group">
                                                    <td className="px-6 py-4 font-medium text-slate-700">{row.date}</td>
                                                    <td className="px-6 py-4 text-slate-500">{row.stopTime}</td>
                                                    <td className="px-6 py-4 text-slate-500">{row.startTime}</td>
                                                    <td className="px-6 py-4">
                                                        <span className="font-bold text-slate-800">{row.duration}</span>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${
                                                            row.durationSec > 300 ? 'bg-rose-100 text-rose-600' : 
                                                            row.durationSec > 60 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'
                                                        }`}>
                                                            <span className={`w-1.5 h-1.5 rounded-full ${
                                                                row.durationSec > 300 ? 'bg-rose-600' : 
                                                                row.durationSec > 60 ? 'bg-amber-600' : 'bg-emerald-600'
                                                            }`}></span>
                                                            {row.durationSec > 300 ? 'Critical' : row.durationSec > 60 ? 'Warning' : 'Normal'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        // --- Render Application Safely ---
        const init = () => {
            const container = document.getElementById('root');
            if (container) {
                const root = ReactDOM.createRoot(container);
                root.render(<App />);
            }
        };

        if (document.readyState === 'complete') {
            init();
        } else {
            window.addEventListener('load', init);
        }
    </script>
</body>
</html>
