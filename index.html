<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Realtime Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '#3b82f6',
                            secondary: '#6366f1',
                            dark: '#0f172a',
                            surface: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Sarabun:wght@300;400;600&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .header-font { font-family: 'Chakra Petch', sans-serif; }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 dark:bg-[#020617] dark:text-slate-100 min-h-screen custom-scrollbar">
    <div id="root"></div>

    <script>
        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Cell, PieChart, Pie } = window.Recharts;

        // Configuration
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3bMRlkNzI9MlH2Ao1EHtRkAyPaat5PsM9Tt0AFjEQnjRASOSweRbk8l_2Nc-Rt9e37NejA7BVzsef/pub?gid=0&single=true&output=csv";

        // Helpers
        const parseTime = (str) => {
            if (!str || str === '-') return 0;
            const p = str.split(':').map(Number);
            return p.length === 3 ? (p[0] * 3600 + p[1] * 60 + p[2]) : (p[0] * 60 + p[1]);
        };

        const formatDuration = (sec) => {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return h > 0 ? `${h}à¸Šà¸¡. ${m}à¸™.` : `${m}à¸™. ${s}à¸§.`;
        };

        const convertDateFormat = (thaiDate) => {
            const [d, m, y] = thaiDate.split('/');
            return `${y}-${m}-${d}`; // ISO format for easy comparison
        };

        function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(true);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [lastUpdated, setLastUpdated] = useState(new Date());

            // Initialize theme
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            const fetchData = async () => {
                try {
                    const res = await fetch(`${SHEET_URL}&t=${new Date().getTime()}`);
                    const text = await res.text();
                    const rows = text.split('\n').filter(r => r.trim());
                    const parsed = rows.slice(1).map((row, idx) => {
                        const cols = row.split(',').map(c => c.trim().replace(/"/g, ''));
                        return {
                            id: idx,
                            date: cols[0],
                            isoDate: convertDateFormat(cols[0]),
                            stop: cols[1],
                            start: cols[2],
                            dur: cols[3],
                            cum: cols[4],
                            durSec: parseTime(cols[3])
                        };
                    });
                    setData(parsed);
                    setLastUpdated(new Date());
                    
                    // Set default date range if not set
                    if (parsed.length > 0 && !startDate) {
                        setStartDate(parsed[0].isoDate);
                        setEndDate(parsed[parsed.length - 1].isoDate);
                    }
                } catch (err) {
                    console.error("Fetch error:", err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000); // Auto update every 30s
                return () => clearInterval(interval);
            }, []);

            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const d = item.isoDate;
                    return (!startDate || d >= startDate) && (!endDate || d <= endDate);
                });
            }, [data, startDate, endDate]);

            const stats = useMemo(() => {
                const totalSec = filteredData.reduce((acc, curr) => acc + curr.durSec, 0);
                const maxSec = Math.max(...filteredData.map(d => d.durSec), 0);
                return {
                    count: filteredData.length,
                    total: formatDuration(totalSec),
                    avg: formatDuration(Math.round(totalSec / (filteredData.length || 1))),
                    max: formatDuration(maxSec)
                };
            }, [filteredData]);

            if (loading) return e('div', { className: "flex items-center justify-center h-screen bg-slate-900" }, [
                e('div', { className: "text-center" }, [
                    e('div', { className: "w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" }),
                    e('p', { className: "text-blue-400 font-bold animate-pulse" }, "LOADING DASHBOARD...")
                ])
            ]);

            return e('div', { className: "max-w-[1400px] mx-auto p-4 md:p-8 space-y-8" }, [
                
                // --- Header Section ---
                e('header', { className: "flex flex-col md:flex-row justify-between items-start md:items-center gap-6" }, [
                    e('div', null, [
                        e('div', { className: "flex items-center gap-3 mb-1" }, [
                            e('div', { className: "w-3 h-3 bg-emerald-500 rounded-full pulse" }),
                            e('h1', { className: "header-font text-3xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-500 dark:from-blue-400 dark:to-emerald-400" }, "GENERATOR MONITORING")
                        ]),
                        e('p', { className: "text-slate-500 dark:text-slate-400 text-sm font-medium flex items-center gap-2" }, [
                            "Real-time Data Update",
                            e('span', { className: "px-2 py-0.5 rounded bg-slate-200 dark:bg-slate-800 text-[10px]" }, lastUpdated.toLocaleTimeString())
                        ])
                    ]),
                    
                    // Filter & Theme Controls
                    e('div', { className: "flex flex-wrap items-center gap-3" }, [
                        e('div', { className: "glass flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700" }, [
                            e('input', { 
                                type: 'date', 
                                value: startDate, 
                                onChange: (e) => setStartDate(e.target.value),
                                className: "bg-transparent text-xs outline-none dark:text-white"
                            }),
                            e('span', { className: "text-slate-400 text-xs" }, "à¸–à¸¶à¸‡"),
                            e('input', { 
                                type: 'date', 
                                value: endDate, 
                                onChange: (e) => setEndDate(e.target.value),
                                className: "bg-transparent text-xs outline-none dark:text-white"
                            }),
                        ]),
                        e('button', { 
                            onClick: () => setDarkMode(!darkMode),
                            className: "p-3 rounded-xl glass hover:bg-white dark:hover:bg-slate-700 transition shadow-sm"
                        }, darkMode ? "â˜€ï¸" : "ðŸŒ™")
                    ])
                ]),

                // --- Stat Cards ---
                e('div', { className: "grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6" }, [
                    { label: "à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸”à¸±à¸š", val: stats.count, unit: "à¸„à¸£à¸±à¹‰à¸‡", color: "from-blue-500 to-blue-700", icon: "ðŸ”Œ" },
                    { label: "à¹€à¸§à¸¥à¸²à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", val: stats.total, unit: "", color: "from-indigo-500 to-purple-600", icon: "â±ï¸" },
                    { label: "à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸„à¸£à¸±à¹‰à¸‡", val: stats.avg, unit: "", color: "from-emerald-500 to-teal-600", icon: "ðŸ“Š" },
                    { label: "à¸”à¸±à¸šà¸™à¸²à¸™à¸—à¸µà¹ˆà¸ªà¸¸à¸”", val: stats.max, unit: "", color: "from-rose-500 to-orange-600", icon: "âš ï¸" }
                ].map(s => e('div', { key: s.label, className: `relative overflow-hidden p-5 rounded-3xl bg-gradient-to-br ${s.color} text-white shadow-xl flex flex-col justify-between h-32 md:h-40` }, [
                    e('span', { className: "text-white/70 text-xs font-bold uppercase tracking-wider" }, s.label),
                    e('div', { className: "flex items-end justify-between" }, [
                        e('div', null, [
                            e('h3', { className: "header-font text-2xl md:text-3xl font-bold" }, s.val),
                            e('span', { className: "text-[10px] text-white/80" }, s.unit)
                        ]),
                        e('span', { className: "text-3xl opacity-30" }, s.icon)
                    ]),
                    e('div', { className: "absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full blur-2xl" })
                ]))),

                // --- Main Visualization ---
                e('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-6" }, [
                    // Large Area Chart
                    e('div', { className: "lg:col-span-2 glass p-6 rounded-[2rem]" }, [
                        e('div', { className: "flex justify-between items-center mb-8" }, [
                            e('h3', { className: "header-font font-bold text-lg dark:text-white" }, "Timeline: à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²à¸à¸²à¸£à¸«à¸¢à¸¸à¸”à¸—à¸³à¸‡à¸²à¸™ (à¸§à¸´à¸™à¸²à¸—à¸µ)"),
                            e('span', { className: "text-[10px] bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 px-3 py-1 rounded-full font-bold" }, "HISTORICAL DATA")
                        ]),
                        e('div', { className: "h-[350px] w-full" }, e(ResponsiveContainer, null, e(AreaChart, { data: filteredData }, [
                            e('defs', null, e('linearGradient', { id: "colorTrend", x1: "0", y1: "0", x2: "0", y2: "1" }, [
                                e('stop', { offset: "5%", stopColor: "#3b82f6", stopOpacity: 0.3 }),
                                e('stop', { offset: "95%", stopColor: "#3b82f6", stopOpacity: 0 })
                            ])),
                            e(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: darkMode ? "#334155" : "#e2e8f0" }),
                            e(XAxis, { 
                                dataKey: "stop", 
                                fontSize: 10, 
                                tick: {fill: darkMode ? "#94a3b8" : "#64748b"}, 
                                axisLine: false,
                                tickMargin: 10
                            }),
                            e(YAxis, { 
                                fontSize: 10, 
                                tick: {fill: darkMode ? "#94a3b8" : "#64748b"}, 
                                axisLine: false,
                                tickMargin: 10
                            }),
                            e(Tooltip, { 
                                cursor: { stroke: '#3b82f6', strokeWidth: 2 },
                                contentStyle: { 
                                    backgroundColor: darkMode ? '#1e293b' : '#ffffff', 
                                    borderRadius: '16px', 
                                    border: 'none', 
                                    boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1)',
                                    color: darkMode ? '#f1f5f9' : '#1e293b'
                                },
                                formatter: (v) => [formatDuration(v), "à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸”à¸±à¸š"]
                            }),
                            e(Area, { 
                                type: "monotone", 
                                dataKey: "durSec", 
                                stroke: "#3b82f6", 
                                strokeWidth: 4, 
                                fill: "url(#colorTrend)",
                                animationDuration: 1500
                            })
                        ])))
                    ]),

                    // Summary Bar Chart
                    e('div', { className: "glass p-6 rounded-[2rem] flex flex-col" }, [
                        e('h3', { className: "header-font font-bold text-lg mb-2 dark:text-white" }, "Daily Analysis"),
                        e('p', { className: "text-xs text-slate-400 mb-8" }, "à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¹€à¸§à¸¥à¸²à¸£à¸§à¸¡à¸£à¸²à¸¢à¸§à¸±à¸™"),
                        e('div', { className: "flex-1 min-h-[300px]" }, e(ResponsiveContainer, null, e(BarChart, { 
                            data: Array.from(new Set(filteredData.map(d => d.date))).map(date => ({
                                date,
                                total: filteredData.filter(item => item.date === date).reduce((a, b) => a + b.durSec, 0)
                            }))
                        }, [
                            e(XAxis, { dataKey: "date", fontSize: 9, tick: {fill: "#94a3b8"}, axisLine: false }),
                            e(Tooltip, { 
                                cursor: {fill: 'rgba(59, 130, 246, 0.1)', radius: 10},
                                contentStyle: { backgroundColor: darkMode ? '#0f172a' : '#fff', border: 'none', borderRadius: '12px' },
                                formatter: (v) => [formatDuration(v), "à¹€à¸§à¸¥à¸²à¸£à¸§à¸¡"]
                            }),
                            e(Bar, { dataKey: "total", radius: [10, 10, 0, 0] }, 
                                filteredData.map((entry, index) => e(Cell, { key: index, fill: index % 2 === 0 ? '#3b82f6' : '#6366f1' }))
                            )
                        ])))
                    ])
                ]),

                // --- Detailed Table ---
                e('div', { className: "glass rounded-[2rem] overflow-hidden" }, [
                    e('div', { className: "p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center" }, [
                        e('h3', { className: "header-font font-bold text-lg dark:text-white" }, "Detailed Log Table"),
                        e('button', { className: "px-4 py-2 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-xl text-xs font-bold hover:scale-105 transition" }, "EXPORT PDF")
                    ]),
                    e('div', { className: "overflow-x-auto" }, e('table', { className: "w-full" }, [
                        e('thead', { className: "bg-slate-50/50 dark:bg-slate-900/50 text-[10px] text-slate-400 font-bold uppercase tracking-widest" }, e('tr', null, 
                            ['à¸§à¸±à¸™à¸—à¸µà¹ˆ', 'à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸”à¸±à¸š (Stop)', 'à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸•à¸´à¸” (Start)', 'à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²', 'à¸ªà¸°à¸ªà¸¡ (Cumulative)', 'Status'].map(h => e('th', { className: "px-8 py-5" }, h))
                        )),
                        e('tbody', { className: "divide-y divide-slate-100 dark:divide-slate-800" }, filteredData.slice().reverse().map(r => e('tr', { key: r.id, className: "hover:bg-blue-50/30 dark:hover:bg-blue-900/10 transition-colors" }, [
                            e('td', { className: "px-8 py-4 font-semibold text-sm" }, r.date),
                            e('td', { className: "px-8 py-4 text-slate-500 text-sm" }, r.stop),
                            e('td', { className: "px-8 py-4 text-slate-500 text-sm" }, r.start),
                            e('td', { className: "px-8 py-4" }, e('span', { className: "font-bold text-rose-500" }, r.dur)),
                            e('td', { className: "px-8 py-4 font-bold text-blue-500" }, r.cum),
                            e('td', { className: "px-8 py-4" }, e('div', { className: "flex items-center gap-2" }, [
                                e('span', { className: `w-2 h-2 rounded-full ${r.durSec > 300 ? 'bg-rose-500' : r.durSec > 60 ? 'bg-amber-500' : 'bg-emerald-500'}` }),
                                e('span', { className: "text-[10px] font-bold opacity-70" }, r.durSec > 300 ? 'SEVERE' : r.durSec > 60 ? 'WARNING' : 'NORMAL')
                            ]))
                        ])))
                    ]))
                ]),

                e('footer', { className: "text-center py-10" }, [
                    e('p', { className: "text-[10px] text-slate-400 font-bold tracking-[0.2em]" }, "DESIGNED FOR HIGH PERFORMANCE MONITORING â€¢ 2026")
                ])
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
