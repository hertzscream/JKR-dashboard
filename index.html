<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Log Dashboard - Full Version</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Prop-Types (Required for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Recharts (Pinned Stable Version) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        :root {
            --primary: #2563eb;
        }
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 1.5rem;
        }
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .animate-enter {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .error-box { color: #dc2626; padding: 20px; background: #fee2e2; border-radius: 8px; text-align: center; margin: 20px; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #2563eb; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #64748b; font-family: sans-serif;">กำลังโหลดระบบ Dashboard...</p>
        </div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <script>
        // Safety Check for Libraries
        if (!window.React || !window.ReactDOM || !window.Recharts) {
            document.getElementById('root').innerHTML = '<div class="error-box"><h3>ไม่สามารถโหลดไลบรารีได้</h3><p>กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต (React/Recharts)</p></div>';
            throw new Error("Missing libraries");
        }

        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;
        const { 
            AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, BarChart, Bar, Cell 
        } = window.Recharts;

        // --- SVG Icons ---
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const paths = {
                upload: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>`,
                activity: `<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>`,
                clock: `<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`,
                database: `<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>`,
                alert: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>`,
                download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>`
            };
            return e('svg', {
                dangerouslySetInnerHTML: { __html: paths[name] || '' },
                viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2",
                strokeLinecap: "round", strokeLinejoin: "round", className: className
            });
        };

        // --- Data Utilities ---
        const timeToSeconds = (str) => {
            if (!str || str === '-' || typeof str !== 'string') return 0;
            const parts = str.trim().split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return 0;
        };

        const secondsToHms = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (h > 0) return `${h} ชม. ${m} นาที`;
            if (m > 0) return `${m} นาที ${sec} วิ`;
            return `${sec} วิ`;
        };

        // Initial Data
        const RAW_DATA = [
            { date: "27/01/2026", stop: "16:57:02", start: "16:57:20", dur: "0:00:17", cum: "0:00:17" },
            { date: "27/01/2026", stop: "16:59:00", start: "16:59:09", dur: "0:00:08", cum: "0:00:26" },
            { date: "28/01/2026", stop: "10:16:15", start: "10:17:29", dur: "0:01:14", cum: "0:01:40" },
            { date: "28/01/2026", stop: "10:17:52", start: "10:18:03", dur: "0:00:11", cum: "0:01:51" },
            { date: "28/01/2026", stop: "-", start: "11:20:01", dur: "0:47:11", cum: "0:49:03" },
            { date: "28/01/2026", stop: "11:21:18", start: "11:21:48", dur: "0:00:30", cum: "0:49:33" },
            { date: "28/01/2026", stop: "11:23:33", start: "11:27:07", dur: "0:03:34", cum: "0:53:07" },
            { date: "28/01/2026", stop: "11:48:07", start: "11:50:59", dur: "0:02:52", cum: "0:56:00" }
        ];

        function App() {
            const [data, setData] = useState([]);
            const [filterDate, setFilterDate] = useState('All');
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                try {
                    const processed = RAW_DATA.map((d, i) => ({
                        ...d, id: i, durSec: timeToSeconds(d.dur), cumSec: timeToSeconds(d.cum)
                    }));
                    setData(processed);
                    setTimeout(() => setIsLoaded(true), 300);
                } catch (err) {
                    console.error("Data Init Error:", err);
                }
            }, []);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const text = evt.target.result;
                        const rows = text.split('\n').filter(r => r.trim());
                        // Assuming row 0 is header, data starts from row 1
                        const parsed = rows.slice(1).map((row, i) => {
                            const c = row.split(',').map(v => v.trim());
                            return {
                                id: i, date: c[0] || "", stop: c[1] || "", start: c[2] || "", 
                                dur: c[3] || "0:00:00", cum: c[4] || "0:00:00",
                                durSec: timeToSeconds(c[3]), cumSec: timeToSeconds(c[4])
                            };
                        });
                        setData(parsed);
                        setFilterDate('All');
                    } catch (err) {
                        alert("เกิดข้อผิดพลาดในการอ่านไฟล์: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const filteredData = useMemo(() => 
                filterDate === 'All' ? data : data.filter(d => d.date === filterDate)
            , [data, filterDate]);

            const dateOptions = useMemo(() => ['All', ...new Set(data.map(d => d.date))], [data]);

            const summary = useMemo(() => {
                const total = filteredData.reduce((acc, cur) => acc + cur.durSec, 0);
                const maxVal = Math.max(...filteredData.map(d => d.durSec), 0);
                const maxRow = filteredData.find(d => d.durSec === maxVal);
                return {
                    count: filteredData.length,
                    totalStr: secondsToHms(total),
                    avgStr: secondsToHms(Math.round(total / (filteredData.length || 1))),
                    maxStr: maxRow ? maxRow.dur : '0:00:00',
                    totalRaw: total
                };
            }, [filteredData]);

            if (!isLoaded) return null; // Let the static loader show

            return e('div', { className: "min-h-screen pb-12 px-4 md:px-8 max-w-7xl mx-auto space-y-6 animate-enter" }, [
                // Header
                e('header', { key: 'header', className: "pt-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4" }, [
                    e('div', { key: 'title-grp' }, [
                        e('div', { className: "flex items-center gap-2 mb-2" }, [
                            e('div', { className: "p-2 bg-blue-600 text-white rounded-lg shadow-lg shadow-blue-200" }, e(Icon, { name: 'database', className: "w-5 h-5" })),
                            e('span', { className: "text-xs font-bold text-blue-600 uppercase tracking-widest" }, "Generator Log Insight")
                        ]),
                        e('h1', { className: "text-3xl md:text-4xl font-extrabold text-slate-900" }, "Performance Dashboard"),
                        e('p', { className: "text-slate-500 mt-1" }, "รายงานสถิติการขัดข้องและการทำงานเชิงลึก")
                    ]),
                    e('div', { key: 'ctrl-grp', className: "flex flex-wrap gap-3 w-full md:w-auto" }, [
                        e('div', { key: 'sel', className: "relative flex-1 md:flex-none" }, [
                            e('select', { 
                                className: "w-full appearance-none bg-white border border-slate-200 pl-4 pr-10 py-3 rounded-2xl text-sm font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 custom-shadow transition-all",
                                value: filterDate,
                                onChange: (e) => setFilterDate(e.target.value)
                            }, dateOptions.map(d => e('option', { key: d, value: d }, d === 'All' ? 'ดูทุกช่วงเวลา' : `วันที่ ${d}`)))
                        ]),
                        e('label', { key: 'upl', className: "bg-slate-900 text-white px-6 py-3 rounded-2xl text-sm font-bold cursor-pointer hover:bg-slate-800 transition-all flex items-center justify-center gap-2 custom-shadow active:scale-95" }, [
                            e(Icon, { name: 'upload', className: "w-4 h-4" }), "Import CSV",
                            e('input', { type: 'file', className: "hidden", accept: ".csv", onChange: handleFileUpload })
                        ])
                    ])
                ]),

                // Stats Cards
                e('div', { key: 'stats', className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" }, [
                    { t: 'เครื่องดับสะสม', v: summary.count + ' ครั้ง', i: 'activity', c: 'bg-blue-600', d: 'จำนวนครั้งที่เกิดการขัดข้อง' },
                    { t: 'ระยะเวลารวม', v: summary.totalStr, i: 'clock', c: 'bg-rose-600', d: 'รวมเวลาที่เครื่องหยุดทำงาน' },
                    { t: 'เฉลี่ยต่อครั้ง', v: summary.avgStr, i: 'activity', c: 'bg-amber-500', d: 'ประสิทธิภาพความไวในการกู้คืน' },
                    { t: 'ดับนานที่สุด', v: summary.maxStr, i: 'alert', c: 'bg-slate-800', d: 'สถิติการหยุดชะงักที่รุนแรงที่สุด' }
                ].map((s, idx) => e('div', { key: idx, className: "glass-card p-6 rounded-3xl flex items-start gap-4 hover:border-blue-200 transition-colors group" }, [
                    e('div', { className: `${s.c} p-3 rounded-2xl text-white shadow-lg shadow-${s.c.split('-')[1]}-100 group-hover:scale-110 transition-transform` }, e(Icon, { name: s.i })),
                    e('div', null, [
                        e('p', { className: "text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1" }, s.t),
                        e('h3', { className: "text-xl font-extrabold text-slate-900" }, s.v),
                        e('p', { className: "text-[10px] text-slate-400 mt-1 italic" }, s.d)
                    ])
                ]))),

                // Charts Section
                e('div', { key: 'charts', className: "grid grid-cols-1 lg:grid-cols-3 gap-6" }, [
                    // Main Trend Chart
                    e('div', { key: 'trend', className: "lg:col-span-2 glass-card p-8 rounded-3xl custom-shadow" }, [
                        e('div', { className: "flex justify-between items-center mb-8" }, [
                            e('div', null, [
                                e('h3', { className: "font-bold text-slate-800 text-lg" }, "Trend Analysis"),
                                e('p', { className: "text-xs text-slate-400" }, "กราฟวิเคราะห์ระยะเวลาการหยุดทำงานแยกตามเหตุการณ์")
                            ]),
                            e('div', { className: "px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-[10px] font-bold" }, "Duration (Sec)")
                        ]),
                        e('div', { className: "h-[320px] w-full" }, e(ResponsiveContainer, null, e(AreaChart, { data: filteredData }, [
                            // Native SVG defs inside Recharts context
                            e('defs', { key: 'defs' }, 
                                e('linearGradient', { id: "colorDur", x1: "0", y1: "0", x2: "0", y2: "1" }, [
                                    e('stop', { key: 's1', offset: "5%", stopColor: "#2563eb", stopOpacity: 0.1 }),
                                    e('stop', { key: 's2', offset: "95%", stopColor: "#2563eb", stopOpacity: 0 })
                                ])
                            ),
                            e(CartesianGrid, { key: 'grid', strokeDasharray: "3 3", vertical: false, stroke: "#f1f5f9" }),
                            e(XAxis, { key: 'x', dataKey: "stop", fontSize: 10, tick: {fill: '#64748b'}, axisLine: false }),
                            e(YAxis, { key: 'y', fontSize: 10, tick: {fill: '#64748b'}, axisLine: false }),
                            e(Tooltip, { 
                                key: 'tip',
                                contentStyle: { borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)', padding: '16px' },
                                formatter: (v) => [secondsToHms(v), "ระยะเวลาที่ดับ"]
                            }),
                            e(Area, { 
                                key: 'area',
                                type: "monotone", dataKey: "durSec", stroke: "#2563eb", strokeWidth: 4, 
                                fillOpacity: 1, fill: "url(#colorDur)", animationDuration: 1500 
                            })
                        ])))
                    ]),
                    // Bar Chart
                    e('div', { key: 'bar', className: "glass-card p-8 rounded-3xl custom-shadow" }, [
                        e('h3', { className: "font-bold text-slate-800 text-lg mb-2" }, "Daily Total"),
                        e('p', { className: "text-xs text-slate-400 mb-8" }, "เปรียบเทียบเวลารวมที่เครื่องดับในแต่ละวัน"),
                        e('div', { className: "h-[320px] w-full" }, e(ResponsiveContainer, null, e(BarChart, { 
                            data: dateOptions.filter(d => d !== 'All').map(d => ({
                                date: d,
                                total: data.filter(row => row.date === d).reduce((a, b) => a + b.durSec, 0)
                            }))
                        }, [
                            e(XAxis, { key: 'xb', dataKey: "date", fontSize: 10, tick: {fill: '#64748b'}, axisLine: false }),
                            e(Tooltip, { 
                                key: 'tb',
                                cursor: {fill: '#f8fafc'},
                                contentStyle: { borderRadius: '12px', border: 'none' },
                                formatter: (v) => [secondsToHms(v), "เวลารวมต่อวัน"]
                            }),
                            e(Bar, { key: 'bb', dataKey: "total", radius: [8, 8, 0, 0] }, [
                                e(Cell, { key: 'c1', fill: "#2563eb" }), e(Cell, { key: 'c2', fill: "#f59e0b" })
                            ])
                        ])))
                    ])
                ]),

                // Detailed Table
                e('div', { key: 'table', className: "glass-card rounded-3xl custom-shadow overflow-hidden" }, [
                    e('div', { className: "p-6 border-b border-slate-100 bg-white/50 flex justify-between items-center" }, [
                        e('div', null, [
                            e('h3', { className: "font-bold text-slate-800" }, "Event Log History"),
                            e('p', { className: "text-xs text-slate-400" }, "ข้อมูลบันทึกรายละเอียดแบบแถวต่อแถว")
                        ]),
                        e('button', { 
                            className: "text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1",
                            onClick: () => window.print()
                        }, [e(Icon, { name: 'download', className: "w-3 h-3" }), "Export Report"])
                    ]),
                    e('div', { className: "overflow-x-auto custom-scrollbar" }, e('table', { className: "w-full text-left" }, [
                        e('thead', { className: "bg-slate-50/80 text-[10px] text-slate-400 uppercase font-bold tracking-widest border-b border-slate-100" }, e('tr', null, 
                            ['วันที่', 'เวลาเครื่องดับ', 'เวลาเครื่องติด', 'ระยะเวลาที่ดับ', 'ดับสะสมทั้งหมด', 'สถานะ'].map(h => e('th', { key: h, className: "px-8 py-5" }, h))
                        )),
                        e('tbody', { className: "text-sm divide-y divide-slate-100" }, filteredData.map(r => e('tr', { key: r.id, className: "hover:bg-blue-50/30 transition-colors" }, [
                            e('td', { className: "px-8 py-5 font-semibold text-slate-700 whitespace-nowrap" }, r.date),
                            e('td', { className: "px-8 py-5 text-slate-500" }, r.stop),
                            e('td', { className: "px-8 py-5 text-slate-500" }, r.start),
                            e('td', { className: "px-8 py-5" }, e('span', { className: `px-3 py-1 rounded-lg font-bold ${r.durSec > 60 ? 'text-rose-600 bg-rose-50' : 'text-slate-600 bg-slate-100'}` }, r.dur)),
                            e('td', { className: "px-8 py-5 font-bold text-blue-600" }, r.cum),
                            e('td', { className: "px-8 py-5" }, e('div', { className: "flex items-center gap-2" }, [
                                e('div', { className: `w-2 h-2 rounded-full ${r.durSec > 300 ? 'bg-rose-500 animate-pulse' : r.durSec > 60 ? 'bg-amber-500' : 'bg-emerald-500'}` }),
                                e('span', { className: "text-[10px] font-bold text-slate-400 uppercase" }, r.durSec > 300 ? 'Critical' : r.durSec > 60 ? 'Warning' : 'Normal')
                            ]))
                        ])))
                    ]))
                ]),

                // Footer
                e('footer', { key: 'foot', className: "text-center pt-8 border-t border-slate-200" }, [
                    e('p', { className: "text-[10px] text-slate-400 uppercase tracking-widest" }, "Generator Monitoring System v2.5.0 - Full Optimized")
                ])
            ]);
        }

        // --- Error Boundary for Safe Render ---
        try {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(e(App));
        } catch (err) {
            console.error("Critical Render Error:", err);
            document.body.innerHTML = '<div class="error-box"><h3>เกิดข้อผิดพลาดในการแสดงผล</h3><p>' + err.message + '</p></div>';
        }
    </script>
</body>
</html>
