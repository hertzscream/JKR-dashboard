<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Realtime Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '#3b82f6',
                            secondary: '#6366f1',
                            dark: '#0f172a',
                            surface: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Sarabun:wght@300;400;600&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .header-font { font-family: 'Chakra Petch', sans-serif; }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 dark:bg-[#020617] dark:text-slate-100 min-h-screen custom-scrollbar">
    <div id="root"></div>

    <script>
        const { useState, useEffect, useMemo } = React;
        const e = React.createElement;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Cell } = window.Recharts;

        // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Google Sheets (‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á Browser)
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3bMRlkNzI9MlH2Ao1EHtRkAyPaat5PsM9Tt0AFjEQnjRASOSweRbk8l_2Nc-Rt9e37NejA7BVzsef/pub?gid=0&single=true&output=csv";

        const parseTime = (str) => {
            if (!str || str === '-' || typeof str !== 'string') return 0;
            const p = str.trim().split(':').map(Number);
            if (p.length === 3) return (p[0] * 3600 + p[1] * 60 + p[2]);
            if (p.length === 2) return (p[0] * 60 + p[1]);
            return 0;
        };

        const formatDuration = (sec) => {
            if (isNaN(sec) || sec === 0) return "0 ‡∏ß.";
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return h > 0 ? `${h}‡∏ä‡∏°. ${m}‡∏ô.` : m > 0 ? `${m}‡∏ô. ${s}‡∏ß.` : `${s}‡∏ß.`;
        };

        const convertDateFormat = (thaiDate) => {
            if (!thaiDate || !thaiDate.includes('/')) return '';
            const parts = thaiDate.split('/');
            if (parts.length !== 3) return '';
            const [d, m, y] = parts;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        };

        function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(true);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [lastUpdated, setLastUpdated] = useState(new Date());
            const [status, setStatus] = useState('connecting'); // connecting, online, offline

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            const processCSVData = (text) => {
                try {
                    const rows = text.split(/\r?\n/).filter(r => r.trim());
                    if (rows.length < 2) return;
                    
                    const parsed = rows.slice(1).map((row, idx) => {
                        // ‡πÅ‡∏¢‡∏Å CSV ‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô)
                        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ''));
                        return {
                            id: idx,
                            date: cols[0],
                            isoDate: convertDateFormat(cols[0]),
                            stop: cols[1],
                            start: cols[2],
                            dur: cols[3],
                            cum: cols[4],
                            durSec: parseTime(cols[3])
                        };
                    }).filter(item => item.isoDate !== '');

                    setData(parsed);
                    setStatus('online');
                    
                    if (parsed.length > 0 && !startDate) {
                        const sorted = [...parsed].sort((a, b) => a.isoDate.localeCompare(b.isoDate));
                        setStartDate(sorted[0].isoDate);
                        setEndDate(sorted[sorted.length - 1].isoDate);
                    }
                } catch (err) {
                    console.error("Parse error:", err);
                    setStatus('offline');
                }
            };

            const fetchData = async () => {
                try {
                    // ‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á Cache
                    const response = await fetch(`${SHEET_URL}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error("CORS or Network Error");
                    const text = await response.text();
                    processCSVData(text);
                    setLastUpdated(new Date());
                } catch (err) {
                    console.warn("Auto-fetch failed, waiting for manual upload or proxy...");
                    setStatus('offline');
                } finally {
                    setLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => processCSVData(evt.target.result);
                reader.readAsText(file);
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 60000); 
                return () => clearInterval(interval);
            }, []);

            const filteredData = useMemo(() => {
                let filtered = data.filter(item => {
                    return (!startDate || item.isoDate >= startDate) && (!endDate || item.isoDate <= endDate);
                });
                return filtered.sort((a, b) => a.isoDate.localeCompare(b.isoDate));
            }, [data, startDate, endDate]);

            const stats = useMemo(() => {
                const totalSec = filteredData.reduce((acc, curr) => acc + curr.durSec, 0);
                const maxSec = filteredData.length > 0 ? Math.max(...filteredData.map(d => d.durSec)) : 0;
                return {
                    count: filteredData.length,
                    total: formatDuration(totalSec),
                    avg: formatDuration(filteredData.length > 0 ? Math.round(totalSec / filteredData.length) : 0),
                    max: formatDuration(maxSec)
                };
            }, [filteredData]);

            return e('div', { className: "max-w-[1400px] mx-auto p-4 md:p-8 space-y-8" }, [
                
                // --- Top Navigation ---
                e('header', { className: "flex flex-col md:flex-row justify-between items-start md:items-center gap-6" }, [
                    e('div', null, [
                        e('div', { className: "flex items-center gap-3 mb-1" }, [
                            e('div', { className: `w-3 h-3 rounded-full ${status === 'online' ? 'bg-emerald-500 pulse' : 'bg-rose-500'}` }),
                            e('h1', { className: "header-font text-3xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-500 dark:from-blue-400 dark:to-emerald-400" }, "GEN MONITOR PRO")
                        ]),
                        e('p', { className: "text-slate-500 dark:text-slate-400 text-sm font-medium" }, 
                            status === 'online' ? `‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ${lastUpdated.toLocaleTimeString()}` : "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV)"
                        )
                    ]),
                    
                    e('div', { className: "flex flex-wrap items-center gap-3 w-full md:w-auto" }, [
                        // Manual Upload
                        e('label', { className: "flex-1 md:flex-none glass px-4 py-2.5 rounded-2xl text-xs font-bold cursor-pointer hover:bg-blue-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2 border border-blue-200 dark:border-slate-700" }, [
                            "üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV",
                            e('input', { type: 'file', accept: '.csv', className: 'hidden', onChange: handleFileUpload })
                        ]),
                        // Date Pickers
                        e('div', { className: "glass flex items-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 dark:border-slate-700" }, [
                            e('input', { 
                                type: 'date', 
                                value: startDate, 
                                onChange: (e) => setStartDate(e.target.value),
                                className: "bg-transparent text-xs outline-none dark:text-white"
                            }),
                            e('span', { className: "text-slate-400" }, "‚Üí"),
                            e('input', { 
                                type: 'date', 
                                value: endDate, 
                                onChange: (e) => setEndDate(e.target.value),
                                className: "bg-transparent text-xs outline-none dark:text-white"
                            }),
                        ]),
                        e('button', { 
                            onClick: () => setDarkMode(!darkMode),
                            className: "p-3 rounded-2xl glass hover:bg-white dark:hover:bg-slate-700 transition"
                        }, darkMode ? "‚òÄÔ∏è" : "üåô")
                    ])
                ]),

                // --- Empty State ---
                data.length === 0 && !loading && e('div', { className: "glass p-20 rounded-[3rem] text-center space-y-4 shadow-inner" }, [
                    e('div', { className: "text-6xl" }, "üìä"),
                    e('h2', { className: "text-2xl font-bold dark:text-white" }, "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"),
                    e('p', { className: "text-slate-500 max-w-sm mx-auto" }, "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Browser ‡∏ï‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (CORS) ‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV' ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•"),
                    e('a', { 
                        href: SHEET_URL, 
                        target: "_blank",
                        className: "inline-block px-6 py-3 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition"
                    }, "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á")
                ]),

                data.length > 0 && e(React.Fragment, null, [
                    // --- Summary Cards ---
                    e('div', { className: "grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6" }, [
                        { label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏±‡∏ö", val: stats.count, unit: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á", color: "from-blue-600 to-blue-400" },
                        { label: "‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°", val: stats.total, unit: "", color: "from-indigo-600 to-purple-500" },
                        { label: "‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á", val: stats.avg, unit: "", color: "from-emerald-600 to-teal-500" },
                        { label: "‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", val: stats.max, unit: "", color: "from-rose-600 to-orange-500" }
                    ].map(s => e('div', { key: s.label, className: `p-6 rounded-[2.5rem] bg-gradient-to-br ${s.color} text-white shadow-2xl shadow-blue-500/10` }, [
                        e('p', { className: "text-white/70 text-[10px] font-bold uppercase tracking-widest mb-2" }, s.label),
                        e('h3', { className: "header-font text-2xl font-bold" }, s.val),
                        e('p', { className: "text-xs text-white/50" }, s.unit)
                    ]))),

                    // --- Charts Area ---
                    e('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-6" }, [
                        e('div', { className: "lg:col-span-2 glass p-8 rounded-[3rem]" }, [
                            e('h3', { className: "header-font font-bold mb-8 dark:text-white text-lg" }, "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)"),
                            e('div', { className: "h-[350px] w-full" }, e(ResponsiveContainer, null, e(AreaChart, { data: filteredData }, [
                                e('defs', null, e('linearGradient', { id: "colorTrend", x1: "0", y1: "0", x2: "0", y2: "1" }, [
                                    e('stop', { offset: "5%", stopColor: "#3b82f6", stopOpacity: 0.4 }),
                                    e('stop', { offset: "95%", stopColor: "#3b82f6", stopOpacity: 0 })
                                ])),
                                e(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: darkMode ? "#334155" : "#e2e8f0" }),
                                e(XAxis, { dataKey: "stop", fontSize: 10, tick: {fill: "#94a3b8"}, axisLine: false }),
                                e(YAxis, { fontSize: 10, tick: {fill: "#94a3b8"}, axisLine: false }),
                                e(Tooltip, { 
                                    contentStyle: { backgroundColor: darkMode ? '#1e293b' : '#fff', borderRadius: '20px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)' },
                                    formatter: (v) => [formatDuration(v), "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤"]
                                }),
                                e(Area, { type: "monotone", dataKey: "durSec", stroke: "#3b82f6", strokeWidth: 4, fill: "url(#colorTrend)" })
                            ])))
                        ]),
                        e('div', { className: "glass p-8 rounded-[3rem] flex flex-col" }, [
                            e('h3', { className: "header-font font-bold mb-8 dark:text-white text-lg" }, "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"),
                            e('div', { className: "flex-1 min-h-[300px]" }, e(ResponsiveContainer, null, e(BarChart, { 
                                data: Array.from(new Set(filteredData.map(d => d.date))).map(date => ({
                                    date,
                                    total: filteredData.filter(item => item.date === date).reduce((a, b) => a + b.durSec, 0)
                                }))
                            }, [
                                e(XAxis, { dataKey: "date", fontSize: 10, tick: {fill: "#94a3b8"}, axisLine: false }),
                                e(Tooltip, { 
                                    cursor: {fill: 'rgba(59, 130, 246, 0.1)'},
                                    contentStyle: { backgroundColor: darkMode ? '#1e293b' : '#fff', border: 'none', borderRadius: '15px' },
                                    formatter: (v) => [formatDuration(v), "‡∏£‡∏ß‡∏°"]
                                }),
                                e(Bar, { dataKey: "total", fill: "#6366f1", radius: [12, 12, 12, 12] })
                            ])))
                        ])
                    ]),

                    // --- Table ---
                    e('div', { className: "glass rounded-[3rem] overflow-hidden shadow-2xl border border-white/20 dark:border-slate-800" }, [
                        e('div', { className: "overflow-x-auto" }, e('table', { className: "w-full text-left" }, [
                            e('thead', { className: "bg-slate-50/50 dark:bg-slate-900/50 text-[11px] text-slate-400 font-bold uppercase tracking-[0.2em]" }, e('tr', null, 
                                ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏±‡∏ö', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î', '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', '‡∏™‡∏∞‡∏™‡∏°', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'].map(h => e('th', { className: "px-10 py-6" }, h))
                            )),
                            e('tbody', { className: "divide-y divide-slate-100 dark:divide-slate-800" }, filteredData.slice().reverse().map(r => e('tr', { key: r.id, className: "hover:bg-blue-50/20 dark:hover:bg-blue-900/10 transition-colors" }, [
                                e('td', { className: "px-10 py-5 text-sm font-semibold" }, r.date),
                                e('td', { className: "px-10 py-5 text-sm text-slate-500" }, r.stop),
                                e('td', { className: "px-10 py-5 text-sm text-slate-500" }, r.start),
                                e('td', { className: "px-10 py-5 text-sm font-bold text-rose-500" }, r.dur),
                                e('td', { className: "px-10 py-5 text-sm font-bold text-blue-500" }, r.cum),
                                e('td', { className: "px-10 py-5" }, 
                                    e('span', { className: `px-4 py-1.5 rounded-xl text-[10px] font-bold ${r.durSec > 60 ? 'bg-rose-100 text-rose-600 dark:bg-rose-900/30' : 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30'}` }, 
                                        r.durSec > 60 ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : '‡∏õ‡∏Å‡∏ï‡∏¥'
                                    )
                                )
                            ])))
                        ]))
                    ])
                ]),

                e('footer', { className: "text-center py-12 opacity-30 text-[10px] font-bold tracking-[0.8em]" }, "GENERATOR MONITORING SYSTEM ‚Ä¢ 2026")
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
