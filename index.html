<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gen Log Interactive Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .recharts-responsive-container { min-height: 300px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, 
            ResponsiveContainer, PieChart, Pie, Cell, Legend 
        } = Recharts;

        // --- Icons from Lucide (using DOM insertion for simplicity in standalone) ---
        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        // --- Helper Functions ---
        const parseDurationToSeconds = (durationStr) => {
            if (!durationStr || durationStr === '-') return 0;
            const parts = durationStr.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return 0;
        };

        const formatSecondsToText = (totalSeconds) => {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            if (h > 0) return `${h} ชม. ${m} นาที`;
            if (m > 0) return `${m} นาที ${s} วิ`;
            return `${s} วินาที`;
        };

        const SAMPLE_DATA = [
            { date: "27/01/2026", stopTime: "16:57:02", startTime: "16:57:20", duration: "0:00:17", cumulative: "0:00:17" },
            { date: "27/01/2026", stopTime: "16:59:00", startTime: "16:59:09", duration: "0:00:08", cumulative: "0:00:26" },
            { date: "28/01/2026", stopTime: "10:16:15", startTime: "10:17:29", duration: "0:01:14", cumulative: "0:01:40" },
            { date: "28/01/2026", stopTime: "10:17:52", startTime: "10:18:03", duration: "0:00:11", cumulative: "0:01:51" },
            { date: "28/01/2026", stopTime: "-", startTime: "11:20:01", duration: "0:47:11", cumulative: "0:49:03" },
            { date: "28/01/2026", stopTime: "11:21:18", startTime: "11:21:48", duration: "0:00:30", cumulative: "0:49:33" },
            { date: "28/01/2026", stopTime: "11:23:33", startTime: "11:27:07", duration: "0:03:34", cumulative: "0:53:07" },
            { date: "28/01/2026", stopTime: "11:48:07", startTime: "11:50:59", duration: "0:02:52", cumulative: "0:56:00" },
        ];

        const COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b'];

        function App() {
            const [data, setData] = useState([]);
            const [selectedDate, setSelectedDate] = useState('All');
            const [minDurationFilter, setMinDurationFilter] = useState(0);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);

            useEffect(() => {
                const processed = SAMPLE_DATA.map((item, index) => ({
                    id: index,
                    ...item,
                    durationSec: parseDurationToSeconds(item.duration),
                    cumulativeSec: parseDurationToSeconds(item.cumulative)
                }));
                setData(processed);
            }, []);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    const dataRows = lines.slice(1);
                    const parsedData = dataRows.map((line, index) => {
                        const cols = line.split(',');
                        if (cols.length < 5) return null;
                        return {
                            id: index,
                            date: cols[0].trim(),
                            stopTime: cols[1].trim(),
                            startTime: cols[2].trim(),
                            duration: cols[3].trim(),
                            cumulative: cols[4].trim(),
                            durationSec: parseDurationToSeconds(cols[3].trim()),
                            cumulativeSec: parseDurationToSeconds(cols[4].trim())
                        };
                    }).filter(item => item !== null);
                    setData(parsedData);
                    setSelectedDate('All');
                };
                reader.readAsText(file);
            };

            const uniqueDates = useMemo(() => ['All', ...new Set(data.map(item => item.date))], [data]);

            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const matchDate = selectedDate === 'All' || item.date === selectedDate;
                    const matchDuration = item.durationSec >= minDurationFilter;
                    return matchDate && matchDuration;
                });
            }, [data, selectedDate, minDurationFilter]);

            const stats = useMemo(() => {
                const totalStops = filteredData.length;
                const totalDowntimeSec = filteredData.reduce((acc, curr) => acc + curr.durationSec, 0);
                const avgDowntimeSec = totalStops > 0 ? totalDowntimeSec / totalStops : 0;
                const maxDowntime = filteredData.reduce((max, curr) => curr.durationSec > max.durationSec ? curr : max, { durationSec: 0 });
                const categories = { short: 0, medium: 0, long: 0 };
                filteredData.forEach(d => {
                    if (d.durationSec < 60) categories.short++;
                    else if (d.durationSec < 300) categories.medium++;
                    else categories.long++;
                });
                const pieData = [
                    { name: 'น้อยกว่า 1 นาที', value: categories.short },
                    { name: '1 - 5 นาที', value: categories.medium },
                    { name: 'มากกว่า 5 นาที', value: categories.long },
                ].filter(d => d.value > 0);
                return { totalStops, totalDowntimeSec, avgDowntimeSec, maxDowntime, pieData };
            }, [filteredData]);

            const StatCard = ({ title, value, subtext, icon, colorClass }) => (
                <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-100 hover:shadow-md transition-shadow">
                    <div className="flex items-start justify-between">
                        <div>
                            <p className="text-sm font-medium text-slate-500">{title}</p>
                            <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                            {subtext && <p className="text-xs text-slate-400 mt-1">{subtext}</p>}
                        </div>
                        <div className={`p-3 rounded-lg ${colorClass} flex items-center justify-center text-white`}>
                            <Icon name={icon} className="w-6 h-6" />
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex">
                    {/* Sidebar */}
                    <aside className={`bg-white border-r border-slate-200 transition-all duration-300 flex flex-col fixed h-full z-20 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                        <div className="p-6 border-b border-slate-100 flex items-center justify-between">
                            {isSidebarOpen && <h1 className="font-bold text-xl text-slate-800 flex items-center gap-2"><Icon name="layout-dashboard" className="text-indigo-600 w-6 h-6" /> Gen Log</h1>}
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-1 hover:bg-slate-100 rounded text-slate-500 mx-auto">
                                <Icon name="chevron-right" className={`transform transition-transform ${isSidebarOpen ? 'rotate-180' : ''}`} />
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            {isSidebarOpen && (
                                <>
                                    <div className="space-y-2">
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">ตัวกรองวันที่</label>
                                        <select value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                                            {uniqueDates.map(date => <option key={date} value={date}>{date === 'All' ? 'แสดงทั้งหมด' : date}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider">ระยะเวลาดับขั้นต่ำ</label>
                                        <select value={minDurationFilter} onChange={(e) => setMinDurationFilter(Number(e.target.value))} className="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                                            <option value={0}>ทั้งหมด</option>
                                            <option value={60}>มากกว่า 1 นาที</option>
                                            <option value={300}>มากกว่า 5 นาที</option>
                                        </select>
                                    </div>
                                    <div className="pt-6 border-t border-slate-100">
                                        <label className="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                                            <Icon name="upload" className="w-6 h-6 mb-2 text-slate-400" />
                                            <p className="text-xs text-slate-500">อัปโหลด CSV</p>
                                            <input type="file" className="hidden" accept=".csv" onChange={handleFileUpload} />
                                        </label>
                                    </div>
                                </>
                            )}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className={`flex-1 transition-all duration-300 ${isSidebarOpen ? 'ml-64' : 'ml-20'} p-8`}>
                        <header className="mb-8 flex justify-between items-end">
                            <div>
                                <h2 className="text-3xl font-bold text-slate-800 tracking-tight">Generator Log Dashboard</h2>
                                <p className="text-slate-500 mt-1">สรุปข้อมูลประสิทธิภาพและการขัดข้องของเครื่องกำเนิดไฟฟ้า</p>
                            </div>
                            <div className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full text-sm font-semibold border border-indigo-100">
                                รายการที่พบ: {filteredData.length} ครั้ง
                            </div>
                        </header>

                        {/* Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <StatCard title="จำนวนครั้งที่ดับ" value={`${stats.totalStops} ครั้ง`} subtext="ในช่วงเวลาที่เลือก" icon="alert-circle" colorClass="bg-indigo-500" />
                            <StatCard title="รวมระยะเวลาดับ" value={formatSecondsToText(stats.totalDowntimeSec)} icon="timer" colorClass="bg-rose-500" />
                            <StatCard title="เฉลี่ยต่อครั้ง" value={formatSecondsToText(stats.avgDowntimeSec)} icon="trending-up" colorClass="bg-amber-500" />
                            <StatCard title="ดับนานที่สุด" value={stats.maxDowntime.duration || "-"} subtext={`เมื่อ: ${stats.maxDowntime.date || '-'}`} icon="check-circle-2" colorClass="bg-emerald-500" />
                        </div>

                        {/* Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-slate-700">
                                    <Icon name="trending-up" className="text-indigo-500" /> แนวโน้มระยะเวลาที่ดับ (Timeline)
                                </h3>
                                <div className="h-[350px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={filteredData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="stopTime" fontSize={11} stroke="#94a3b8" />
                                            <YAxis fontSize={11} stroke="#94a3b8" />
                                            <RechartsTooltip formatter={(val) => formatSecondsToText(val)} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                            <Area type="monotone" dataKey="durationSec" stroke="#6366f1" fill="#6366f1" fillOpacity={0.1} strokeWidth={3} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                                <h3 className="font-bold text-lg mb-6 text-center text-slate-700">สัดส่วนความรุนแรง</h3>
                                <div className="flex-1">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={stats.pieData} innerRadius={60} outerRadius={85} paddingAngle={5} dataKey="value">
                                                {stats.pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                            </Pie>
                                            <RechartsTooltip />
                                            <Legend verticalAlign="bottom" align="center" iconType="circle" />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Table */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                                <h3 className="font-bold text-lg flex items-center gap-2 text-slate-700">
                                    <Icon name="file-text" className="text-slate-400" /> รายละเอียดบันทึกเหตุการณ์
                                </h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead>
                                        <tr className="text-slate-500 text-xs uppercase tracking-wider">
                                            <th className="p-4 border-b border-slate-100">วันที่</th>
                                            <th className="p-4 border-b border-slate-100">เวลาดับ</th>
                                            <th className="p-4 border-b border-slate-100">เวลาติด</th>
                                            <th className="p-4 border-b border-slate-100">ระยะเวลา</th>
                                            <th className="p-4 border-b border-slate-100">สะสม</th>
                                            <th className="p-4 border-b border-slate-100 text-center">ระดับ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm divide-y divide-slate-50">
                                        {filteredData.map((row) => (
                                            <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-4 font-semibold text-slate-700">{row.date}</td>
                                                <td className="p-4 text-slate-600">{row.stopTime}</td>
                                                <td className="p-4 text-slate-600">{row.startTime}</td>
                                                <td className="p-4 font-bold text-rose-600">{row.duration}</td>
                                                <td className="p-4 text-indigo-600">{row.cumulative}</td>
                                                <td className="p-4 text-center">
                                                    <span className={`px-2.5 py-1 rounded-full text-[10px] font-bold uppercase ${
                                                        row.durationSec > 300 ? 'bg-rose-100 text-rose-600' : 
                                                        row.durationSec > 60 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'
                                                    }`}>
                                                        {row.durationSec > 300 ? 'Critical' : row.durationSec > 60 ? 'Warning' : 'Minor'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>